let math = require("math.txt");
let utils = require("utils.txt");
let resources = require("resources/resourceUtils.txt");

let wnd = api.window();
wnd.create(1280, 720);

let device = api.device();
let swapChain = api.swapChain();
let commandQueue = api.commandQueue();
let fence = api.fence();

let generalInit = func() {
	device.create();
	commandQueue.create(device);
	swapChain.create(device, wnd, commandQueue);
	fence.create(device);
	print("General Init!");
};

generalInit();

let cameraInputHandler = api.aux.camera();
let initCamera = func() {
	let pos = math.vector3(0, 2, 0);
	let target = math.vector3(0, 2, 5);

	let aspect = wnd.width() / wnd.height();
	cameraInputHandler.setPosition(pos);
	cameraInputHandler.setTarget(target);
	cameraInputHandler.setAspect(aspect);
	cameraInputHandler.setNearPlane(0.1);
	cameraInputHandler.setFarPlane(10000);
	cameraInputHandler.setFOV(60);

	api.app_context.inputHandler = cameraInputHandler;
};
initCamera();

let renderer = api.renderer.renderer();

renderer.setWindow(wnd);
renderer.setDevice(device);
renderer.setSwapChain(swapChain);
renderer.setCommandQueue(commandQueue);
renderer.setFence(fence);


let rendererReady = func() {
	if (renderer.camBuff == none 
		|| renderer.scene == none
		|| renderer.materialRepo == none) {
		return;
	}
	api.app_context.renderer = renderer;
};

let resources = require("resources/resourceUtils.txt");
let camBB = resources.bufferBuilder();
camBB.upload(1);
camBB.setSize(256);
camBB.setStride(256);

camBB.build(device, func(buff) {
	renderer.setCamBuff(buff);
	rendererReady();
});

let materialRepo = api.material.materialRepo();
let simpleUnlit = require("materials/simpleUnlitMat.txt");

simpleUnlit(device, "shaders/unlit.hlsl", func(mat) {
	materialRepo.addMaterial("default", mat);
	renderer.setMaterialRepo(materialRepo);
	rendererReady();
});

let clearRTRS = api.renderer.clearRTRS();
let unlitPass = api.renderer.unlitPass();
renderer.addRenderStage(clearRTRS);
renderer.addRenderStage(unlitPass);

renderer.initRenderStages();

let scene = require("setupScene.txt");

scene(device, func(data) {
	renderer.setScene(data.scene);
	renderer.setMeshRepo(data.meshRepo);
	rendererReady();
});