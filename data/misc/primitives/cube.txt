let generateVertices = func() {
	let cube = api.primitives.cube();

	let data = {};
	data.vertexData = cube.getVertices();
	data.indexData = cube.getIndices();
	return data;
};

let prepareData = func(device, onReady) {
	let verts = generateVertices();
	
	let resources = require("resources/resourceUtils.txt");

	let vertexUploadBB = resources.bufferBuilder();
	vertexUploadBB.upload(1);
	vertexUploadBB.setSize(4 * verts.vertexData.length);
	vertexUploadBB.setStride(32);

	let vertexBB = resources.bufferBuilder();
	vertexBB.upload(0);
	vertexBB.setSize(4 * verts.vertexData.length);
	vertexBB.setStride(32);

	let indexUploadBB = resources.bufferBuilder();
	indexUploadBB.upload(1);
	indexUploadBB.setSize(4 * verts.indexData.length);
	indexUploadBB.setStride(4);

	let indexBB = resources.bufferBuilder();
	indexBB.upload(0);
	indexBB.setSize(4 * verts.indexData.length);
	indexBB.setStride(4);

	let vertexUploadBuff = none;
	let vertexBuff = none;
	let indexUploadBuff = none;
	let indexBuff = none;

	let copyLeft = 2;

	let dataPrepared = func() {
		if (copyLeft > 0) {
			return;
		}

		let res = {};
		res.vertex = vertexBuff;
		res.index = indexBuff;

		onReady(res);
	};

	let copyVertex = func() {
		if (vertexUploadBuff == none || vertexBuff == none) {
			return;
		}
		resources.copyBuffers(device, vertexBuff.buffer, vertexUploadBuff.buffer, func() {
			copyLeft = copyLeft - 1;
			dataPrepared();
		});
	};

	let copyIndex = func() {
		if (indexUploadBuff == none || indexBuff == none) {
			return;
		}

		resources.copyBuffers(device, indexBuff.buffer, indexUploadBuff.buffer, func() {
			copyLeft = copyLeft - 1;
			dataPrepared();
		});
	};

	vertexUploadBB.build(device, func(buff) {
		vertexUploadBuff = buff;
		vertexUploadBuff.buffer.copyData(verts.vertexData);
		copyVertex();
	});

	vertexBB.build(device, func(buff) {
		vertexBuff = buff;
		copyVertex();
	});

	indexUploadBB.build(device, func(buff) {
		indexUploadBuff = buff;
		indexUploadBuff.buffer.copyIntData(verts.indexData);
		copyIndex();
	});

	indexBB.build(device, func(buff) {
		indexBuff = buff;
		copyIndex();
	});
};


export = prepareData;